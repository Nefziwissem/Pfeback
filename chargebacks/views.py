from django.shortcuts import render
from .models import Chargeback,Comment
from .serializers import ChargebackSerializer
from rest_framework.response import Response
from rest_framework import generics, status
from django.shortcuts import get_object_or_404
from rest_framework import viewsets
from .serializers import CommentSerializer
from django.shortcuts import get_object_or_404

from rest_framework import status
from rest_framework.response import Response
from rest_framework.decorators import api_view
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import ChargebackSerializer
from .models import Chargeback


from django.core.mail import send_mail
from django.http import Http404, JsonResponse
from .models import Chargeback
from rest_framework.permissions import IsAuthenticated

# views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework import status
from .models import Comment
from .serializers import CommentSerializer

from rest_framework import status
from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from .serializers import CommentSerializer
from .models import Comment
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from django.utils.dateparse import parse_date
from rest_framework.views import APIView
from rest_framework.response import Response
from .models import Chargeback
from .serializers import ChargebackSerializer


from rest_framework.decorators import api_view
from rest_framework.response import Response
from .models import Comment




# views.py
from rest_framework import status
from rest_framework.response import Response
from .models import Chargeback
from .serializers import ChargebackSerializer

from .serializers import ActionLogSerializer

from .models import ActionLog

import logging
import logging
import logging

from django.http import HttpResponse
from django.core.files import File

from django.http import FileResponse
from django.shortcuts import get_object_or_404
from .models import File

# views.py in your Django app

# views.py

from rest_framework import status, permissions
from rest_framework.response import Response
from rest_framework.views import APIView
from .models import Chargeback
from .serializers import ChargebackSerializer


# views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from .models import Chargeback, File
from .serializers import FileSerializer


from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from .models import Chargeback
from .serializers import ChargebackSerializer

# views.py in your Django app
from rest_framework.views import APIView
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback, File
from django.shortcuts import get_object_or_404
import logging
import logging



from django.utils import timezone
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from rest_framework.exceptions import AuthenticationFailed
    
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import ChargebackSerializer
from .models import Chargeback
from .serializers import ChargebackSerializer



from rest_framework import viewsets
from .models import Comment
from .serializers import CommentSerializer
from rest_framework import viewsets
from rest_framework.decorators import action
from .models import Comment
from .serializers import CommentSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from .serializers import CommentSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from .serializers import CommentSerializer

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import CommentSerializer
from .models import Comment
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import CommentSerializer
from django.shortcuts import get_object_or_404
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback, File
from .serializers import FileSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import ChargebackSerializer

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback
from .serializers import ChargebackSerializer

import logging
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback, ActionLog
from .serializers import ActionLogSerializer

import logging
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAdminUser
from .models import ActionLog
from .serializers import ActionLogSerializer


from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import File, Chargeback
from .serializers import FileSerializer
from django.shortcuts import get_object_or_404

from rest_framework import generics
from .models import File
from .serializers import FileSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import ActionLog, Chargeback
from .serializers import ActionLogSerializer
import logging
from rest_framework import generics
from rest_framework.permissions import IsAuthenticated
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.response import Response

from rest_framework.views import APIView
from rest_framework.exceptions import AuthenticationFailed
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated




from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from .models import Chargeback
from .serializers import ChargebackSerializer

###CRUDChargebacks
from rest_framework.permissions import IsAuthenticated

from rest_framework import views, status
from rest_framework.response import Response
from .models import Chargeback
from .serializers import ChargebackSerializer

from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.response import Response

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from django.shortcuts import get_object_or_404
from .models import Chargeback
from rest_framework.response import Response
from rest_framework import status
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from .models import Chargeback
from .serializers import ChargebackSerializer
from rest_framework.response import Response





import joblib
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
import joblib
import os
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings
import joblib
import os
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings

import joblib
import os
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings

from rest_framework import status

import logging
logger = logging.getLogger(__name__)
class ChargebackUpdateView(generics.UpdateAPIView):
    queryset = Chargeback.objects.all()
    serializer_class = ChargebackSerializer



def update(self, request, *args, **kwargs):
    logger.debug(f"Received update data: {request.data}")
    partial = kwargs.pop('partial', True)  # Allowing partial updates
    serializer = self.get_serializer(data=request.data, instance=self.get_object(), partial=partial)
    serializer.is_valid(raise_exception=True)
    self.perform_update(serializer)
    return Response(serializer.data)



import os
import joblib
import pandas as pd
import matplotlib.pyplot as plt
import logging
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings
from django.http import FileResponse
from io import BytesIO

logger = logging.getLogger(__name__)

class PredictResolutionTime(APIView):
    def post(self, request):
        model_path = os.path.join(settings.BASE_DIR, 'models', 'chargeback_resolution_model.pkl')
        logger.debug(f"Model path: {model_path}")
        try:
            if not os.path.exists(model_path):
                logger.error(f"Model file not found at path: {model_path}")
                return Response({'error': 'Model file not found'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
            
            model = joblib.load(model_path)
            data = request.data
            logger.debug(f"Data received: {data}")
            
            # Sélection des colonnes nécessaires pour la prédiction
            columns = ['authorization_number', 'amount', 'status', 'reason']
            input_data = {col: data[col] for col in columns if col in data}
            
            # Transformation des données en DataFrame
            df = pd.DataFrame([input_data])
            
            # Assurez-vous que les colonnes sont encodées de la même manière que lors de l'entraînement
            df['status_encoded'] = df['status'].map({
                'created': 0,
                'sent_to_merchant': 1,
                'processing_by_Xerox': 2,
                'processing_by_bank': 3,
                'won': 4,
                'lost': 5,
                'desactivated': 6,
                'reactivate': 7
            })
            df['reason_encoded'] = df['reason'].map({
                'Customer dispute': 0,
                'Fraud': 1,
                'Technical issue': 2
            })
            df = df[['authorization_number', 'amount', 'status_encoded', 'reason_encoded']]
            
            # Prédiction
            prediction = model.predict(df)
            logger.debug(f"Prediction: {prediction[0]}")

            # Générer la courbe de régression
            X_train = pd.read_csv('X_train.csv')
            y_train = pd.read_csv('y_train.csv')

            plt.figure(figsize=(10, 6))
            plt.scatter(X_train['amount'], y_train, color='blue', label='Training Data', alpha=0.5)
            plt.scatter(df['amount'], prediction, color='red', label='Prediction')
            plt.xlabel('Amount')
            plt.ylabel('Resolution Time (days)')
            plt.title(f'Regression Model Prediction\nPredicted Resolution Time: {prediction[0]:.2f} days')
            plt.legend()

            # Sauvegarder la courbe en tant qu'image
            buffer = BytesIO()
            plt.savefig(buffer, format='png')
            buffer.seek(0)
            
            response = FileResponse(buffer, content_type='image/png', as_attachment=True, filename='prediction_plot.png')
            response['predicted_resolution_time_days'] = prediction[0]
            return response
        
        except FileNotFoundError:
            logger.error('Model file not found exception')
            return Response({'error': 'Model file not found'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
        except Exception as e:
            logger.error(f"An error occurred: {str(e)}")
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)



class ChargebackDeleteView(APIView):

    def delete(self, request, *args, **kwargs):
        pk = kwargs.get('pk')
        chargeback = get_object_or_404(Chargeback, pk=pk)
        chargeback.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)



class ChargebackListView(APIView):
    def get(self, request):
        # Get the date parameter from the query string
        date = request.query_params.get('date', None)
        if date:
            # Parse the string date to a date object
            date_obj = parse_date(date)
            # Filter chargebacks by the parsed date
            chargebacks = Chargeback.objects.filter(creation_date__date=date_obj)
        else:
            chargebacks = Chargeback.objects.all()
        
        serializer = ChargebackSerializer(chargebacks, many=True)
        return Response(serializer.data)




class ChargebackDetailView(APIView):

    def get(self, request, pk):
        try:
            chargeback = Chargeback.objects.get(pk=pk)
            serializer = ChargebackSerializer(chargeback)
            return Response(serializer.data)
        except Chargeback.DoesNotExist:
            return Response({'error': 'Chargeback not found'}, status=status.HTTP_404_NOT_FOUND)
        
        

    def put(self, request, pk):
        try:
            chargeback = Chargeback.objects.get(pk=pk)
            serializer = ChargebackSerializer(chargeback, data=request.data)
            if serializer.is_valid():
                serializer.save()
                return Response(serializer.data)
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        except Chargeback.DoesNotExist:
            return Response({'error': 'Chargeback not found'}, status=status.HTTP_404_NOT_FOUND)
        
        

    def delete(self, request, pk):
        try:
            chargeback = Chargeback.objects.get(pk=pk)
            chargeback.delete()
            return Response(status=status.HTTP_204_NO_CONTENT)
        except Chargeback.DoesNotExist:
            return Response({'error': 'Chargeback not found'}, status=status.HTTP_404_NOT_FOUND)




   


from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import CommentSerializer
from django.contrib.auth.models import User  # Importer le modèle d'utilisateur Django

from rest_framework.response import Response
from rest_framework.views import APIView
from .models import Comment
from .serializers import CommentSerializer
from rest_framework import status

from django.contrib.auth.models import User
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from .serializers import CommentSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from .serializers import CommentSerializer
class CommentView(APIView):
    def get(self, request, chargeback_id):
        comments = Comment.objects.filter(chargeback_id=chargeback_id)
        serializer = CommentSerializer(comments, many=True)
        return Response(serializer.data)
    
    def post(self, request, chargeback_id):
        serializer = CommentSerializer(data=request.data, context={'request': request, 'view': self})
        if serializer.is_valid():
            user = request.user
            serializer.validated_data['first_name'] = user.first_name
            serializer.validated_data['last_name'] = user.last_name
            serializer.validated_data['chargeback_id'] = chargeback_id
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def put(self, request, comment_id):
        try:
            comment = Comment.objects.get(id=comment_id)
            serializer = CommentSerializer(comment, data=request.data, partial=True)
            if serializer.is_valid():
                serializer.save()
                return Response(serializer.data)
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        except Comment.DoesNotExist:
            return Response({"message": "Comment not found"}, status=status.HTTP_404_NOT_FOUND)

    def delete(self, request, comment_id):
        try:
            comment = Comment.objects.get(id=comment_id)
            comment.delete()
            return Response(status=status.HTTP_204_NO_CONTENT)
        except Comment.DoesNotExist:
            return Response({"message": "Comment not found"}, status=status.HTTP_404_NOT_FOUND)
        

        
   


    
   

class ChargebackStatusUpdateView(APIView):
    def patch(self, request, pk):
        chargeback = Chargeback.objects.get(pk=pk)
        serializer = ChargebackSerializer(chargeback, data=request.data, partial=True, context={'request': request})
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_200_OK)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)











class ChargebackLogsView(APIView):
    permission_classes = [IsAdminUser]  # This ensures only admin users can access this view

    def get(self, request, pk):
        logs = ActionLog.objects.filter(chargeback__id=pk).order_by('-created_at')
        if not logs.exists():
            return Response({'message': 'No logs found'}, status=404)
        serializer = ActionLogSerializer(logs, many=True)
        return Response(serializer.data)
    
    
class ChargebackCreateView(APIView):
    def get(self, request):
        chargebacks = Chargeback.objects.all()
        serializer = ChargebackSerializer(chargebacks, many=True)
        return Response(serializer.data)

    def post(self, request):
        serializer = ChargebackSerializer(data=request.data, context={'request': request})
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    



class FileUploadView(APIView):
    def post(self, request, pk):
        chargeback = get_object_or_404(Chargeback, pk=pk)
        file_serializer = FileSerializer(data=request.data, context={'request': request})
        
        if file_serializer.is_valid():
            file_serializer.save(chargeback=chargeback)
            return Response(file_serializer.data, status=status.HTTP_201_CREATED)
        else:
            return Response(file_serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class FileCreateView(generics.CreateAPIView):
    queryset = File.objects.all()
    serializer_class = FileSerializer

class FileListView(generics.ListAPIView):
    queryset = File.objects.all()
    serializer_class = FileSerializer

class FileDetailView(generics.RetrieveUpdateDestroyAPIView):
    queryset = File.objects.all()
    serializer_class = FileSerializer


# views.py
# views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from .models import Chargeback
# views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from .models import Chargeback

class ToggleActiveStatus(APIView):
    def patch(self, request, chargeback_id):
        chargeback = get_object_or_404(Chargeback, id=chargeback_id)
        chargeback.is_active = not chargeback.is_active
        chargeback.save()
        print(f"Chargeback {chargeback.id} new is_active status: {chargeback.is_active}")
        return Response({"success": True, "is_active": chargeback.is_active}, status=status.HTTP_200_OK)


def download_file(request, file_id):
    file_obj = get_object_or_404(File, id=file_id)
    response = FileResponse(file_obj.file.open(), as_attachment=True, filename=file_obj.file.name)
    return response




@api_view(['DELETE'])
def delete_file(request, pk):
    file = get_object_or_404(File, pk=pk)
    file.delete()
    return Response(status=status.HTTP_204_NO_CONTENT)






# views.py


# def send_email_to_merchant(request, chargeback_id):

#     try:
#         chargeback = Chargeback.objects.get(pk=chargeback_id)
#         subject = "Request for Chargeback Documentation"
#         message = f"Dear {chargeback.merchant_name},\n\nWe are reviewing a chargeback claim on a transaction and require additional documentation from you."
#         email_from = 'samaraouadi7@gmail.com'
#         recipient_list = [chargeback.merchant_email]

#         send_mail(subject, message, email_from, recipient_list)
#         return JsonResponse({'message': 'Email sent successfully!'}, status=200)
#     except Chargeback.DoesNotExist:
#         return JsonResponse({'error': 'Chargeback not found'}, status=404)


from django.core.mail import send_mail
from django.conf import settings
from django.shortcuts import get_object_or_404
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework import status
from users.models import User
import logging

logger = logging.getLogger(__name__)


class AssignChargebackView(APIView):
    def patch(self, request, pk):
        chargeback = Chargeback.objects.get(pk=pk)
        user_id = request.data.get('assigned_to')
        if user_id:
            chargeback.assigned_to_id = user_id
            chargeback.save(update_fields=['assigned_to'])
            return Response({"status": "Chargeback assigned successfully."}, status=status.HTTP_200_OK)
        return Response({"error": "Invalid request"}, status=status.HTTP_400_BAD_REQUEST)
from rest_framework import status
from rest_framework.response import Response
from rest_framework.views import APIView
from .models import Comment
from .serializers import CommentSerializer

class CommentListView(APIView):
    def get(self, request, chargeback_id):
        comments = Comment.objects.filter(chargeback_id=chargeback_id, parent=None)
        serializer = CommentSerializer(comments, many=True)
        return Response(serializer.data)

    def post(self, request, chargeback_id):
        serializer = CommentSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save(chargeback_id=chargeback_id)
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


class CommentDetailView(APIView):
    def get_object(self, comment_id):
        try:
            return Comment.objects.get(id=comment_id)
        except Comment.DoesNotExist:
            raise Http404

    def get(self, request, comment_id, format=None):
        comment = self.get_object(comment_id)
        serializer = CommentSerializer(comment)
        return Response(serializer.data)
  
    def post(self, request, chargeback_id):
        serializer = CommentSerializer(data=request.data, context={'request': request, 'view': self})
        if serializer.is_valid():
            user = request.user
            serializer.validated_data['first_name'] = user.first_name
            serializer.validated_data['last_name'] = user.last_name
            serializer.validated_data['chargeback_id'] = chargeback_id
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        else:
            print(serializer.errors)  # Print the validation errors to the console
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def delete(self, request, comment_id, format=None):
        comment = self.get_object(comment_id)
        comment.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import Comment

class CommentLikeView(APIView):
    def post(self, request, comment_id, format=None):
        comment = Comment.objects.get(id=comment_id)
        user = request.user
        if user in comment.liked_users.all():
            comment.liked_users.remove(user)
            comment.likes -= 1
            liked = False
        else:
            comment.liked_users.add(user)
            comment.likes += 1
            liked = True
        comment.save()
        return Response({'status': 'success', 'liked': liked, 'likes': comment.likes}, status=status.HTTP_200_OK)


class CommentReplyView(APIView):
    def post(self, request, comment_id, format=None):
        parent_comment = Comment.objects.get(id=comment_id)
        text = request.data.get('text')
        reply_comment = Comment.objects.create(text=text, chargeback=parent_comment.chargeback, parent=parent_comment)
        serializer = CommentSerializer(reply_comment)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework import status
from django.db.models import Sum
from django.db.models.functions import TruncMonth
from .models import Chargeback
from .serializers import ChargebackDataSerializer
from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework import status
from django.db.models import Sum
from django.db.models.functions import TruncMonth
from .models import Chargeback
from .serializers import ChargebackDataSerializer
from datetime import date

@api_view(['GET'])
def chargeback_data(request):
    try:
        # Aggregate chargebacks by month
        chargebacks = Chargeback.objects.filter(is_active=True).annotate(month=TruncMonth('creation_date')).values('month').annotate(total_amount=Sum('amount')).order_by('month')
        
        # Convert datetime to date
        for chargeback in chargebacks:
            chargeback['month'] = chargeback['month'].date()  # Convert to date
        
        serializer = ChargebackDataSerializer(chargebacks, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

